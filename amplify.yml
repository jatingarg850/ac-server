version: 1
env:
  variables:
    NODE_ENV: production
    PORT: 8080
    DEBUG: '*'
backend:
  phases:
    preBuild:
      commands:
        - npm install
        - npm install -g pm2
        - node verify-build.js
    build:
      commands:
        - npm run build
    postBuild:
      commands:
        - pm2 delete all || true
        - pm2 start ecosystem.config.cjs --env production
        - sleep 10
        - pm2 list
        - pm2 logs --nostream --lines 100
        - curl -v http://localhost:8080/health || pm2 logs --nostream --lines 100
        - curl -v http://localhost:8080/api/ac-listings || pm2 logs --nostream --lines 100
  artifacts:
    baseDirectory: .
    files:
      - '**/*'
    excludes:
      - src/**/*
      - public/**/*
      - node_modules/**/*
  cache:
    paths:
      - node_modules/**/*
  customHeaders:
    - pattern: '/api/*'
      headers:
        - key: 'Access-Control-Allow-Origin'
          value: '*'
        - key: 'Access-Control-Allow-Headers'
          value: 'Origin,Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept'
        - key: 'Access-Control-Allow-Methods'
          value: 'GET,POST,PUT,DELETE,OPTIONS,HEAD'
        - key: 'Access-Control-Max-Age'
          value: '86400'
        - key: 'Access-Control-Expose-Headers'
          value: 'Access-Control-Allow-Origin'
  proxies:
    - path: '/api/*'
      target: 'http://localhost:8080'
      status: '200-399'
frontend:
  phases:
    preBuild:
      commands:
        - echo "No frontend build required"
    build:
      commands:
        - echo "This is a backend-only application"
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-store'
        - key: 'Access-Control-Allow-Origin'
          value: '*' 