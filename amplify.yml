version: 1
env:
  variables:
    NODE_ENV: production
    PORT: 8080
    DEBUG: '*'
backend:
  phases:
    preBuild:
      commands:
        - 'echo "Current directory: $PWD"'
        - 'echo "Directory contents:" && ls -la'
        - npm install
        - npm install -g pm2
        - 'echo "Verifying build configuration..."'
        - node verify-build.js
    build:
      commands:
        - 'echo "Starting build phase..."'
        - npm run build
        - 'echo "Build phase completed"'
    postBuild:
      commands:
        - 'echo "Starting PM2..."'
        - 'pm2 delete all || true'
        - 'pm2 start ecosystem.config.cjs --env production'
        - 'sleep 10'
        - 'echo "PM2 Status:"'
        - pm2 list
        - 'echo "PM2 Logs:"'
        - 'pm2 logs --nostream --lines 100'
        - 'echo "Testing health endpoint..."'
        - 'curl -v "http://localhost:8080/health"'
        - 'echo "Testing API endpoint..."'
        - 'curl -v "http://localhost:8080/api/ac-listings"'
  artifacts:
    baseDirectory: .
    files:
      - index.js
      - package.json
      - package-lock.json
      - ecosystem.config.cjs
      - routes/**/*
      - middleware/**/*
      - db/**/*
      - config/**/*
    excludes:
      - node_modules/**/*
      - src/**/*
      - public/**/*
      - '**/*.md'
      - '**/*.test.js'
  cache:
    paths:
      - node_modules/**/*
  customHeaders:
    - pattern: '/api/*'
      headers:
        - key: 'Access-Control-Allow-Origin'
          value: '*'
        - key: 'Access-Control-Allow-Headers'
          value: 'Origin,Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,Accept'
        - key: 'Access-Control-Allow-Methods'
          value: 'GET,POST,PUT,DELETE,OPTIONS,HEAD'
        - key: 'Access-Control-Max-Age'
          value: '86400'
        - key: 'Access-Control-Expose-Headers'
          value: 'Access-Control-Allow-Origin'
  proxies:
    - path: '/api/*'
      target: 'http://localhost:8080'
      status: '200-399'
frontend:
  phases:
    preBuild:
      commands:
        - 'echo "No frontend build required"'
    build:
      commands:
        - 'echo "This is a backend-only application"'
  artifacts:
    baseDirectory: /
    files:
      - '**/*'
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'no-store'
        - key: 'Access-Control-Allow-Origin'
          value: '*' 